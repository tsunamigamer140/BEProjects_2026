{% extends "ai_app/base.html" %} {% load static %} {% block content %}

<style>
  body {
    background: #f5f7fa;
  }

  .reg-card {
    animation: fadeIn 0.4s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Toasts */
  #toast-container {
    position: fixed;
    top: 25px;
    right: 25px;
    z-index: 99999;
  }
  .toast {
    padding: 12px 18px;
    border-radius: 8px;
    margin-bottom: 10px;
    color: white;
    font-weight: 500;
    animation: slide 0.4s ease-out;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  }
  .toast.success {
    background: #16a34a;
  }
  .toast.error {
    background: #dc2626;
  }

  @keyframes slide {
    from {
      opacity: 0;
      transform: translateX(40px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Card + inputs */
  .form-control {
    border-radius: 10px;
    padding: 12px;
    border: 2px solid #e5e7eb;
    background: #fff;
    transition: 0.2s;
  }
  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.18);
  }

  label {
    font-weight: 600;
    margin-bottom: 6px;
  }

  /* Password Strength */
  .strength-text {
    font-size: 0.85rem;
    margin-top: 5px;
    font-weight: 600;
  }
  .strength-weak {
    color: #dc2626;
  }
  .strength-medium {
    color: #d97706;
  }
  .strength-strong {
    color: #16a34a;
  }
</style>

<div id="toast-container"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-5">
      <div class="card shadow-lg border-0 rounded-4 p-4 reg-card">
        <!-- Logo -->
        <div class="text-center mb-3">
          <img
            src="{% static 'logo.jpg' %}"
            width="75"
            class="rounded-circle shadow-sm"
            alt="Roadmap AI Logo"
          />
        </div>

        <h3 class="text-center fw-bold mb-4">Create Your Account</h3>

        <form id="registerForm" method="POST" novalidate>
          {% csrf_token %}

          <!-- Username -->
          <div class="mb-3">
            <label for="id_username">Username</label>
            <input
              type="text"
              id="id_username"
              name="username"
              class="form-control"
              value="{{ form.username.value|default:'' }}"
              required
            />
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="id_email">Email</label>
            <input
              type="email"
              id="id_email"
              name="email"
              class="form-control"
              value="{{ form.email.value|default:'' }}"
              required
            />
            <small id="emailError" class="text-danger d-none">
              Please enter a valid email address.
            </small>
          </div>

          <!-- Password -->
          <div class="mb-2">
            <label for="id_password">Password</label>
            <input
              type="password"
              id="id_password"
              name="password"
              class="form-control"
              required
            />
            <div id="strengthMsg" class="strength-text strength-weak">
              Too weak
            </div>
          </div>

          <!-- Confirm Password -->
          <div class="mb-3">
            <label for="id_password2">Confirm Password</label>
            <input
              type="password"
              id="id_password2"
              name="password2"
              class="form-control"
              required
            />
            <small id="matchError" class="text-danger d-none">
              Passwords do not match.
            </small>
          </div>

          <button class="btn btn-success w-100 btn-lg">Register</button>

          <p class="text-center mt-3 text-muted">
            Already have an account?
            <a href="{% url 'login' %}" class="fw-bold">Login</a>
          </p>
        </form>

        <!-- Pass Django form errors to JS as JSON (for toasts) -->
        <script id="django-errors" type="application/json">
          {{ form.errors.as_json|safe }}
        </script>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- Toast ----------
  function showToast(msg, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateX(40px)";
      setTimeout(() => toast.remove(), 300);
    }, 2200);
  }

  // ---------- Password Strength ----------
  const pwd = document.getElementById("id_password");
  const strengthMsg = document.getElementById("strengthMsg");

  pwd.addEventListener("input", () => {
    const val = pwd.value;
    let strength = "Too weak";
    let cls = "strength-weak";

    if (val.length >= 6) {
      strength = "Medium";
      cls = "strength-medium";
    }
    if (val.length >= 8 && /[A-Z]/.test(val) && /\d/.test(val)) {
      strength = "Strong";
      cls = "strength-strong";
    }

    strengthMsg.textContent = strength;
    strengthMsg.className = `strength-text ${cls}`;
  });

  // ---------- Email Validation ----------
  const emailField = document.getElementById("id_email");
  const emailError = document.getElementById("emailError");

  emailField.addEventListener("input", () => {
    const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value);
    emailError.classList.toggle("d-none", valid);
  });

  // ---------- Password Match ----------
  const confirmField = document.getElementById("id_password2");
  const matchError = document.getElementById("matchError");

  function checkMatch() {
    const ok = confirmField.value === pwd.value;
    matchError.classList.toggle("d-none", ok);
    return ok;
  }

  confirmField.addEventListener("input", checkMatch);
  pwd.addEventListener("input", checkMatch);

  // ---------- Show success/error toasts from server ----------
  document.addEventListener("DOMContentLoaded", () => {
    // success (just registered)
    const justRegistered = "{{ just_registered|default:'False' }}";
    if (justRegistered === "True") {
      showToast("Account created! Redirecting to loginâ€¦", "success");
      setTimeout(() => {
        window.location.href = "{% url 'login' %}";
      }, 1300);
    }

    // errors from form validation
    const errScript = document.getElementById("django-errors");
    if (errScript && errScript.textContent.trim()) {
      try {
        const errors = JSON.parse(errScript.textContent);
        if (Object.keys(errors).length > 0) {
          // grab first error message
          const firstField = Object.keys(errors)[0];
          const firstMsg =
            (errors[firstField][0] && errors[firstField][0].message) ||
            "Please fix the highlighted errors.";
          showToast(firstMsg, "error");
        }
      } catch (e) {
        // ignore parsing error
      }
    }
  });
</script>

{% endblock %}
